

# 📡 C-Cube UART 通信协议 (草案)

## 1. 物理层

* **接口**: UART0 (PA15=TX, PB2=RX)
* **波特率**: 115200bps (可升级到 1Mbps)
* **数据格式**: 8N1 (8数据位, 无校验, 1停止位)
* **通信模式**: 主机（上位机/手机APP） ↔ 从机（C-Cube 控制器）

---

## 2. 帧结构

```
+--------+--------+--------+--------+--------+--------+--------+--------+
| 0xAA   |  CMD   |  LEN   |   DATA (LEN bytes)                |  CRC16 |
+--------+--------+--------+--------+--------+--------+--------+--------+
```

* **帧头**: 固定 `0xAA`
* **CMD**: 命令字 (1字节)
* **LEN**: 数据长度 (1字节, 不含帧头/命令/长度/CRC)
* **DATA**: 变长数据 (LEN 字节)
* **CRC16**: 校验 (2字节, Modbus-RTU CRC16, 低字节在前)

---

## 3. 命令字定义

| CMD  | 含义                | 方向    | 数据格式 (DATA)                     |
| ---- | ----------------- | ----- | ------------------------------- |
| 0x01 | 设置输入电压阈值          | 主机→从机 | uint16 (mV)                     |
| 0x02 | 设置输出电压阈值          | 主机→从机 | uint16 (mV)                     |
| 0x03 | 设置最大输入电流          | 主机→从机 | uint16 (mA)                     |
| 0x04 | 设置最大输出电流          | 主机→从机 | uint16 (mA)                     |
| 0x05 | 设置最大输出功率          | 主机→从机 | uint16 (mW)                     |
| 0x06 | 查询实时状态            | 主机→从机 | 无                               |
| 0x07 | 实时状态上报            | 从机→主机 | 电压/电流/功率等                       |
| 0x08 | 模式切换 (BUCK/BOOST) | 主机→从机 | uint8 (0=BUCK, 1=BOOST, 2=Auto) |
| 0x09 | ACK/错误码           | 从机→主机 | uint8 (0=OK, 其他=错误码)            |

---

## 4. 数据格式约定

* **电压**: 单位 mV (如 60000 = 60V)
* **电流**: 单位 mA (如 150000 = 150A)
* **功率**: 单位 mW (如 450000 = 450W)
* **模式**: 0=BUCK, 1=BOOST, 2=Auto

---

## 5. 状态帧 (0x07) 示例

```
DATA = [ Vin(2B) | Iin(2B) | Vout(2B) | Iout(2B) | Pout(2B) | Mode(1B) ]
```

* Vin: 输入电压 (mV)
* Iin: 输入电流 (mA)
* Vout: 输出电压 (mV)
* Iout: 输出电流 (mA)
* Pout: 输出功率 (mW)
* Mode: 当前工作模式

总长度 = 11字节

---

## 6. 例子

### 设置输入电压阈值 60V

```
帧: AA 01 02 E0 EA CRC16
解析:
  帧头 0xAA
  CMD=0x01 (设置输入电压阈值)
  LEN=0x02
  DATA=0xE0 0xEA (60000 mV, little-endian)
  CRC16=xxxx
```

### 上报实时状态

```
帧: AA 07 0B 70 17 10 27 60 EA 40 42 20 6D 01 CRC16
解析:
  Vin=6000mV
  Iin=10000mA
  Vout=60000mV
  Iout=16960mA
  Pout=27680mW
  Mode=1 (BOOST)
```

---

## 7. Copilot 任务指令

请 Copilot 按以下要求实现：

1. 编写 `UART_ReceiveHandler()`：按字节接收，解析协议帧，校验 CRC16。
2. 编写 `UART_SendFrame(cmd, data, len)`：封装数据并附加 CRC16。
3. 支持命令字 0x01\~0x09，自动调用对应处理函数（如 `Set_InputVoltage(uint16_t mv)`）。
4. 每隔 100ms 自动发送状态帧 (0x07)。
5. 错误命令返回 ACK 帧 (0x09, 错误码≠0)。

---
