

# 1. 总体设计思路（关键点）

1. **高压测量不要直接上 ADC**：用高阻分压把高压降到安全范围（为了降低功耗分压阻值可做大），再用芯片内部 **OPA 做缓冲/放大**（把高阻源驱动到 ADC 要求的低阻）。手册提醒 ADC 对外部源阻抗有限制（见 RAIN 的最大公式/表），所以必须用 OPA 缓冲或把分压等效阻抗降至允许范围。&#x20;

2. **比较器（CMP）用于快速硬件阈值判断**：把经 OPA 缓冲后的电压送给 CMP 的正输入，用内部 LDAC 或 BG1v0 给 CMP 负端设定阈值（LDAC 可编程 5bit），CMP 输出可触发中断或（在设计允许时）与 PWM/定时器联动以尽快切换模式。手册说明 CMP 支持多个 P 输入和 N0/LDAC/BG1v0 作为负端。

3. **PWM 用 TIM1/TIM8**：TIM1/TIM8 是高级定时器，支持互补输出、死区、BKIN 紧急制动、并能产生 ADC 触发（TRGO）用于同步采样。把主 PWM 由 TIM1（或 TIM8）产生，给从机同步信号（外部线或 TRGO），并用 BKIN 做硬件断开（过流/急停）。

4. **UART 做主从通信与配置下发**（波特率 1\~3 Mbps 可选），建议用 UART0。

---

# 2. 建议的引脚 & 外设映射（以常见 LQFP32/QFN32 引脚为例；请按你选的封装核对）

下列映射是可用且互不冲突的一个推荐方案（从手册的引脚复用表摘录并引用）：

* **测量（ADC）通道**

  * 母线直流（Vin，高压）测量（经分压 + OPA）：`ADC0_IN0` = **PB12**（手册表明 PB12 可作 ADC0\_IN0）。
  * 输出电压（Vout，低侧/电池侧/DC bus）测量（经分压 + OPA）：`ADC0_IN1` = **PB13** 或 `ADC0_IN2` = **PA2**（任选可用通道）——手册列出多通道可供选择。
  * 备用采样/电流采样可用：`ADC0_IN4/5/6`（PA4/PA5/PA6）等（若要测电流或从模块回读）。

* **运算放大器 OPA（用于缓冲/做 PGA）**

  * OPA0 输出：`OPA0_OUT0` -> **PA5**（PA5 在手册中列为 OPA0\_OUT0 / TIM1\_CH1）。可把 ADC 前端 buffer 放在 OPA0。
  * OPA 输入：`OPA0_P0` = **PA3**（正端），`OPA0_N0` = **PA4**（负端）等（手册列出具体复用）。你可以把高压分压接入 OPA 的正输入，OPA 配置为跟随器（或 PGA 模式）。

* **比较器 CMP（用于快速阈值）**

  * CMP0\_OUT 可选引脚：**PB4** 或 **PA9**（手册显示 CMP0\_OUT 有几个映射位置，选一个方便接外部中断或直接做 TIM BKIN 联动）。CMP1\_OUT 可用 **PA8** / **PB7** 等。示例：把 Vin 比较器输出放 CMP1\_OUT（PA8），Vout 比较器放 CMP0\_OUT（PB4）。
  * CMP 负端阈值（N0）可连接内部 `LDAC` 或 `BG1v0`（建议用 LDAC，5bit 可编程，在线微调阈值）。

* **高级定时器 / PWM**

  * 主 PWM（互补输出，带死区）用 **TIM1**（建议）：

    * TIM1\_CH1 = **PA5**（可驱动 MOS 高侧）、TIM1\_CH1N 可选到 PA3/PA7 等（参见引脚复用），TIM1\_BKIN = **PB12** 或 **PA6**（手册中 PB12/PA6 有 BKIN 复用，作为紧急停止）。这样 TIM1 能生成互补通道并处理死区与 BKIN。
  * 副 PWM（如需要第二组推挽或同步输出）用 **TIM8**（TIM8 也有 CH1..CH4，支持同步/触发），其通道分布见手册。TIM1/TIM8 之间可以用触发/同步链接。

* **UART（主从通信）**

  * UART0\_TX = **PA15**（或 PA14 / PA9 / PA8），UART0\_RX = **PB2**（手册列出 PB2 可作 UART0\_RX）。建议：主机 TX = PA15，RX = PB2（物理连线方便且不与 TIM1 主通道冲突）。

> 上面各引脚均可在手册表 3.1 中查到多路复用关系，请按照你最终选封装（LQFP32/QFN32/TSSOP）核对具体引脚编号并调整。

---

# 3. ADC + 分压 + OPA 具体建议（含计算与注意事项）

1. **VDDA / ADC 参考**：建议把芯片的 VDDA 设为 **5.0 V**（PTM280x 支持 2.2–5.5V，且手册 ADC 在 VDDA=2.7\~5.5V 下工作；若你系统 5V 可用则直接以 VDDA=5V，ADC 参考为 VDDA）。

2. **测 Vin（示例）**：

   * 目标：在 Vin = 0..100 V 范围内测量，并在 Vin = 60 V 时给出判阈（但不要直接把 100 V 上到 ADC）。
   * 推荐方案：**高阻分压（R1 // R2 总和 \~1 MΩ 量级）→ OPA 缓冲（输入阻抗高、提供低源阻抗给 ADC）→ ADC**。
   * 推荐分压（示例）：

     * 取 R\_top ≈ 950 kΩ，R\_bot ≈ 50 kΩ（总 \~1 MΩ）→ 比例 ≈ 50k / 1M = 0.05。

       * Vin = 60 V → 分压后 ≈ 3.0 V。
       * Vin = 100 V → 分压后 ≈ 5.0 V（接近 VDDA，注意给 OPA/ADC 留裕度，或把 R\_bottom 设稍大使 100 V 对应 4.5 V）。
   * **为什么用大阻值**：避免在高压上耗大量静态功率。
   * **但注意**：ADC 本身要求驱动源阻抗不高（手册给出 RAIN 最大与采样时间关系，若不使用缓冲需要把等效阻低于表中限值）。因此用大阻值分压时 **必须**使用 OPA 做低阻缓冲（或把 R 总和降到几十千欧并承担功耗）。参见手册 ADC RAIN 限制说明。

3. **OPA 配置**：

   * 把 OPA 配为 **电压跟随器（Gain = 1）或 PGA（若想放大小幅电压）**。手册支持 PGA = ×1、×2、×5、×10，且 OPA 输出可以内部连接到 ADC 或 CMP。若用 1M 分压把 100 V → 5 V，通常 OPA 跟随即可。
   * OPA 输入：把分压输出接到 `OPAx_P0`（例如 PA3），`OPAx_N0`接地或做差分（视测量拓扑）。OPA 输出连到 ADC 输入（例如 OPA0\_OUT0 -> PA5 -> ADC0\_IN5/对应通道）。

4. **ADC 采样、采样时间**：

   * 选择合适的采样时间（tSAM），以确保 RAIN（分压等效阻）不超过表里给出的最大值（见表 5.3.29）。如果使用 OPA 缓冲，ADC 驱动源阻抗问题将被缓解。
   * 推荐：ADC 周期性采样（例如 4\~10 kHz）用于闭环控制与监测；对阈值切换使用 CMP（硬件），同时 ADC 做冗余与记录。

---

# 4. CMP（比较器）配置与阈值管理

1. **功能分配（建议）**：

   * CMP1：检测 **Vin > 60 V**（充电判定） → CMP1 输出触发中断/或驱动逻辑切换到 BUCK。CMP1 的正端接 Vin 经 OPA 缓冲后的电压，负端接 LDAC（5 位 DAC）或外部参考（分压出来的基准）。CMP1\_OUT 可映射到 PA8（或 PB7），用于快速硬件中断。
   * CMP0：检测 **Vout < 55 V**（需 BOOST） → CMP0 输出触发中断/切换到 BOOST。CMP0\_OUT 可映射到 PB4/PA9 等。

2. **阈值设定**：用 **LDAC（5-bit）** 做软件可配置阈值（启动时校准），因为 LDAC 可输出 0…VDDA\*(31/32)，对 CMP 的负端非常方便；若需要更精确阈值可用 ADC 读数结合软件决策做二次确认。

3. **响应路径**：

   * **快速路径（硬件优先）**：CMP 触发 EXTI /中断，立即关闭/切换 TIM（例如立即把 PWM 切到对应模式，或启用 BKIN 保护），减少延迟。
   * **稳态路径（软件确认）**：CMP 触发后，MCU 读 ADC 做平均与防抖（避免瞬时噪声），再执行模式变更并下发给从模块（通过 UART 同步新占空比/模式）。

4. **CMP 与 TIM BKIN**：若你想做硬件级紧急切断（BKIN），可以把 CMP 输出作为外部逻辑拉到 TIM 的 BKIN 输入（若手册允许内部路由则更好）。手册显示 TIM 的 BKIN 与多个引脚复用（PB12/PA6 等），CMP 输出也有多重映射，需根据封装选择物理连线。

---

# 5. PWM（TIM1/TIM8）配置建议（主控产生同步 PWM）

1. **使用 TIM1 作为主 PWM 发生器**（TIM1 支持死区、互补输出、BKIN）：

   * 设置：中心对齐或边沿对齐视拓扑（推挽半桥/全桥）。配置死区时间（按 MOSFET 驱动器与 MOSFET 切换特性计算）。
   * TIM1 输出（CH1/CH1N、CH2/CH2N）驱动主功率桥或输出同步信号给外部门驱（若你把每个从模块的 MOS 直接由从模块本地 PWM 驱动，那么主芯片只需输出定时同步脉冲 +占空比命令）。
   * TIM1 产生的 **TRGO/同步信号** 可用于触发 ADC 同步采样（把采样与 PWM 固定相位对齐，减少采样误差），同时也可做为外部同步线让从模块锁相。手册提到 TIM1/TIM8 能产生 ADC 触发/事件。

2. **多从模块同步方案**：

   * **方案 A（主发 PWM）**：主芯片输出 PWM（或同步脉冲）到每个从模块，从模块直接用该同步信号驱动其本地 MOS（硬件并联功率段）。优点是从模块无需高速通信实时控制，硬件同步好；缺点是主芯片要承受更大 I/O 驱动/布线复杂度。
   * **方案 B（主发命令）**：主芯片只发“占空比/模式/同步时钟”，从模块用本地定时器锁相并生成其 MOS PWM（推荐用于模块化）。建议用 TIM1 TRGO 或外部 GPIO 时钟作为同步源。

3. **安全 & 保护**：

   * BKIN（TIM1\_BKIN 引脚，PB12 / PA6 等）用于外部过流/紧急关断（CMP 或外部断路器驱动 BKIN）。

---

# 6. UART 配置（主从通信）

1. **引脚**：UART0\_TX = **PA15**；UART0\_RX = **PB2**（示例）。你可以把主机作为 UART 主站，用简单命令协议下发占空比/模式并接收从模块状态。

2. **波特率/帧**：建议 115200 或更高（若从模块数量多或需频繁下发，可用 1 Mbps 或 3 Mbps。PTM280x 的 UART 支持最高 3 Mbps）。使用 DMA RX/TX 可以降低 CPU 负担。

---

# 7. 软件工作流程建议（主控）

1. **上电自检**：读取 LDAC/校准 OPA/ADC，读取断路器状态。
2. **常规循环**：

   * 用 CMP 做硬件快速阈值判断：CMP1（Vin>60V）→ 触发立即切换到 BUCK（或先软切，确保死区/死周期安全），CMP0（Vout<55V）→ 切换到 BOOST。
   * CMP 触发同时，MCU 通过 ADC 读 Vin/Vout（多次平均）确认（去抖）。
   * 更新 PWM 占空比（平滑 ramp）并下发命令给从模块（UART）。
3. **保护**：过流/过温等触发 BKIN 或立即将 PWM 拉低并报警。
4. **同步**：使用 TIM1 TRGO 或外部 GPIO 同步信号，确保从模块 PWM 相位一致。

---

# 8. 具体器件/寄存器层的关键点（和手册页的对应）

* **引脚复用 / 选择**：参考手册表 3.1（引脚定义与复用），我在上文选择的引脚都是来自该表，请在你最终的封装下再核对并固定 PIN（见手册引脚表）。
* **ADC 的触发与 TIM1/TIM8 事件**：手册明确 ADC 可被 TIM1/TIM8 触发，适合做同步采样。
* **OPA / CMP / LDAC 说明与性能**：OPA 支持 PGA ×1、×2、×5、×10，LDAC 是 5 位 DAC 可作为 CMP 的参考输入；CMP 有外部/内部阈值选择和中断能力。

---

# 9. 例子（具体数值示范）

* 假设：VDDA = 5.0 V。
* Vin 分压：`Rtop = 950 kΩ`，`Rbot = 50 kΩ` → Vin 100 V -> 5.0 V；Vin 60 V -> 3.0 V。分压后接到 `OPA0_P0 (PA3)`；`OPA0` 配为跟随，输出 `OPA0_OUT0 (PA5)` 驱动 `ADC0_IN5`（PA5/ADC 具体通道在封装中核对）。采样后软件计算实际 Vin = Vadc/0.05。

  * 注意：在分压节点并联一个 TVS/串联电阻+肖特基 来防止反向注入与浪涌。
* CMP 阈值：把 LDAC 设置为等效电压（VDAC = 3.0 V）对应 Vin = 60 V 的分压电平，让 CMP1 比较 OPA 输出与 LDAC；若 OPA\_out > LDAC 则 CMP1 输出高（代表 Vin>60V）。LDAC 可经 UART / I2C（内部寄存器）配置在运行时微调。

---

# 10. Checklist（设计/验证要点）

* [ ] 确定封装（LQFP32/QFN32/...）并核对每个引脚的具体编号/复用。
* [ ] 确定 VDDA 电压（3.3V 或 5.0V）；若用 3.3V，相应调整分压比和 LDAC 阈值。
* [ ] 为高压分压点加浪涌保护（TVS）、RC 滤波与共模滤波（抑制噪声）。
* [ ] 在分压后 **一定**加 OPA 缓冲（若分压阻值较大）。检查 OPA 的共模范围（OPA 文档给出轨到轨输入/输出范围）。
* [ ] 根据 ADC 采样时间表（表 5.3.27 & 表 5.3.29），选择采样时间或使用 OPA 缓冲以满足 RAIN 限制。
* [ ] 设计 PWM 死区与软启动（避免开关瞬态损坏 MOS），并验证 BKIN/硬件紧急制动逻辑。
* [ ] 软件上实现 CMP 中断的去抖（短延时确认）与 ADC 的冗余确认机制，避免抖动引起频繁切换。
* [ ] 对从模块通信协议（UART）做明确协议（心跳/同步/占空比下发/告警回报等）。

---


# 📘 PTM280x 双向 DCDC 控制开发说明书

## 1. 硬件条件

* **封装**：LQFP32
* **VDDA**：5.0 V
* **PWM 驱动对象**：半桥驱动芯片 SA2612（MOSFET 高低桥）
* **应用模式**：双向 DC-DC

  * 当 **Vin > 60V** → 进入 **BUCK 模式（充电）**
  * 当 **Vout < 55V** → 进入 **BOOST 模式（放电补充）**

---

## 2. 引脚分配 (LQFP32)

| 功能            | PTM280x 引脚          | 外设通道/说明                     |
| ------------- | ------------------- | --------------------------- |
| **PWM 高侧**    | PA5                 | TIM1\_CH1，连接到 SA2612 HI 输入  |
| **PWM 低侧**    | PA7                 | TIM1\_CH1N，连接到 SA2612 LI 输入 |
| **紧急关断**      | PB12                | TIM1\_BKIN，过流/保护信号输入        |
| **ADC-Vin**   | PB12 (ADC0\_IN0 复用) | Vin 高压分压 → OPA 缓冲后采样        |
| **ADC-Vout**  | PA2 (ADC0\_IN2)     | Vout 分压 → OPA 缓冲后采样         |
| **OPA0 输入**   | PA3 (P0+)，PA4 (N0-) | 接 Vin/Vout 分压，配置为跟随器/放大     |
| **OPA0 输出**   | PA5 (OPA0\_OUT0)    | 驱动 ADC 输入                   |
| **CMP1 输出**   | PA8                 | Vin > 60V 判定，连接 EXTI/中断     |
| **CMP0 输出**   | PB4                 | Vout < 55V 判定，连接 EXTI/中断    |
| **UART0\_TX** | PA15                | 主从通信                        |
| **UART0\_RX** | PB2                 | 主从通信                        |

> ⚠️ 注意：ADC 与 OPA 引脚在不同复用模式下冲突，请在 CubeMX / 手册中最终确认管脚模式。

---

## 3. ADC 配置

* **分压比设计**：

  * Vin 分压：Rtop=950kΩ, Rbot=50kΩ → Vin=100V → 5V (满量程)
  * Vout 分压：根据目标电池电压（如 48V → 2.4V）调整分压比
* **OPA**：配置为跟随器，缓冲高阻分压信号，输出驱动 ADC
* **ADC 通道**：

  * `ADC0_IN0` (Vin)
  * `ADC0_IN2` (Vout)
* **触发源**：TIM1 TRGO（保证与 PWM 同步采样）
* **采样时间**：按表 5.3.27，tSAM≥1.5 周期，确保满足 RAIN 要求（推荐加 RC 滤波）

---

## 4. CMP 配置

* **CMP1**：

  * 正端：Vin 分压缓冲信号
  * 负端：LDAC 设置为对应 60V 的电平 (≈3.0V)
  * 输出：PA8 → 触发中断，判定进入 BUCK
* **CMP0**：

  * 正端：Vout 分压缓冲信号
  * 负端：LDAC 设置为对应 55V 的电平
  * 输出：PB4 → 触发中断，判定进入 BOOST
* **动作**：硬件快速比较，输出到 EXTI 中断，软件再确认并切换模式

---

## 5. PWM (TIM1) 配置

* **模式**：互补 PWM（CH1/CH1N）
* **频率**：建议 50\~100kHz（根据电感/MOS 选型）
* **死区时间**：根据 SA2612 驱动和 MOSFET 选型计算，一般 100ns\~500ns
* **同步触发**：TIM1 产生 TRGO → 触发 ADC 同步采样
* **紧急关断**：BKIN (PB12)，由过流/比较器控制，一旦触发立即关断 PWM
* **输出分配**：

  * PA5 → TIM1\_CH1 → SA2612 HI
  * PA7 → TIM1\_CH1N → SA2612 LI

---

## 6. UART 配置

* **外设**：UART0
* **引脚**：TX=PA15, RX=PB2
* **波特率**：115200 \~ 1Mbps（根据主从数量选择）
* **协议建议**：

  * 帧格式：`[Header][Cmd][Data][CRC]`
  * 支持：模式切换、占空比下发、状态回报、心跳包

---

## 7. 软件逻辑

1. **初始化**：配置 ADC、OPA、CMP、PWM、UART
2. **主循环**：

   * CMP 触发中断：立即判定 BUCK / BOOST
   * ADC 定期采样 Vin/Vout，做软件滤波与二次确认
   * 根据模式选择更新 PWM 占空比
   * UART 周期性广播模式和同步信息给从机
3. **保护**：

   * BKIN 触发 → 立即关闭 PWM
   * ADC 检测异常电压/过流 → 报警并关闭

---
