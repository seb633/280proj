# 📋 CMix双相DCDC硬件接口检查报告
*检查日期：2025年9月17日*
*硬件规格：PTM280x (LQFP32), VDDA=5.0V, Rs=0.25mΩ, TP181A1 Gain=50*

## 📊 检查结果总览

| 条目 | 状态 | 备注 | 修正建议与代码片段 |
|------|------|------|-------------------|
| **1. ADC通道映射** | ❌ **不满足** | 缺少相A/相B电流通道映射 | [见下方代码修正](#adc-mapping-fix) |
| **2. ADC采样时间与触发** | ⚠️ **部分满足** | TIM1_TRGO已配置，但采样时间不一致 | [见下方代码修正](#adc-timing-fix) |
| **3. 软件换算** | ❌ **完全缺失** | 无TP181A1电流换算公式 | [见下方代码修正](#current-calculation-fix) |
| **4. 外部比较器** | ❌ **完全缺失** | 无外部比较器连接到BKIN | [见下方硬件修正](#external-comparator-fix) |
| **5. CMP使用正确性** | ✅ **满足** | 片内CMP仅用于Vin/Vout阈值 | 配置正确 |
| **6. PCB要点** | ❓ **无法验证** | 代码层面无法检查PCB布局 | [见下方PCB检查清单](#pcb-checklist) |
| **7. 日志输出** | ⚠️ **部分满足** | 有UART输出但缺少相电流显示 | [见下方代码修正](#logging-fix) |

---

## 🔍 详细检查结果

### 1. ADC通道映射 ❌ 不满足
**当前状态**：
- ✅ Vin -> PB12 (ADC0_IN0) 正确
- ✅ Vout -> PA2 (ADC0_IN2) 正确  
- ❌ 相A电流通道 -> **未定义**
- ❌ 相B电流通道 -> **未定义**

**问题**：配置中只有IIN/IOUT概念，缺少明确的相A/相B电流通道

<a id="adc-mapping-fix"></a>
**修正代码**：
```c
/* 在CMix_config.h中添加相A/相B电流采样配置 */

/* 相A电流采样配置 - TP181A1输出A */
#define CMIX_ADC_CURRENT_A_PORT     GPIOA          // 相A电流采样引脚
#define CMIX_ADC_CURRENT_A_PIN      GPIO_Pin_1     // PA1 = ADC0_IN1
#define CMIX_ADC_CURRENT_A_CHANNEL  ADC_Channel_1  // ADC0_IN1

/* 相B电流采样配置 - TP181A1输出B */  
#define CMIX_ADC_CURRENT_B_PORT     GPIOA          // 相B电流采样引脚
#define CMIX_ADC_CURRENT_B_PIN      GPIO_Pin_3     // PA3 = ADC0_IN3
#define CMIX_ADC_CURRENT_B_CHANNEL  ADC_Channel_3  // ADC0_IN3

/* TP181A1电流放大器参数 */
#define CMIX_CURRENT_SENSE_RS       0.00025f       // 分流电阻 0.25mΩ
#define CMIX_CURRENT_SENSE_GAIN     50.0f          // TP181A1增益
#define CMIX_CURRENT_VREF           2.5f           // VDDA/2 = 2.5V基准
```

### 2. ADC采样时间与触发 ⚠️ 部分满足
**当前状态**：
- ✅ TIM1_TRGO触发已配置
- ❌ 采样时间不一致（有3周期也有239周期）
- ⚠️ 未考虑TP181A1输出阻抗

<a id="adc-timing-fix"></a>
**修正代码**：
```c
/* 在CMix_hardware.c的ADC配置中统一采样时间 */
void CMix_Hardware_Init_ADC(void)
{
    // ...现有配置...
    
    /* 🔧 统一采样时间 - 考虑TP181A1输出阻抗 */
    ADC_InitStruct.ADC_SampleTime = 239;  // 最长采样时间 (239.5周期)
    
    /* 配置各通道采样时间 */
    ADC_RegularChannelConfig(CMIX_ADC_UNIT, CMIX_ADC_VIN_CHANNEL,    1, ADC_SampleTime_239_5Cycles);
    ADC_RegularChannelConfig(CMIX_ADC_UNIT, CMIX_ADC_CURRENT_A_CHANNEL, 2, ADC_SampleTime_239_5Cycles);
    ADC_RegularChannelConfig(CMIX_ADC_UNIT, CMIX_ADC_VOUT_CHANNEL,   3, ADC_SampleTime_239_5Cycles);
    ADC_RegularChannelConfig(CMIX_ADC_UNIT, CMIX_ADC_CURRENT_B_CHANNEL, 4, ADC_SampleTime_239_5Cycles);
    
    /* 序列长度设为4 */
    ADC_InitStruct.ADC_NbrOfChannel = 4;
}
```

### 3. 软件换算 ❌ 完全缺失

<a id="current-calculation-fix"></a>
**修正代码**：
```c
/* 在CMix_hardware.c或专门的电流处理文件中添加 */

/**
 * @brief 将ADC原始值转换为实际电流值
 * @param adc_raw: ADC原始值 (0-4095 for 12-bit ADC)
 * @retval 电流值 (A)，负值表示反向电流
 */
float CMix_Hardware_Convert_Current(uint16_t adc_raw)
{
    /* ADC转电压：ADC_RAW * VDDA / 4095 */
    float vadc = (float)adc_raw * 5.0f / 4095.0f;
    
    /* 减去基准电压（VDDA/2） */
    float vdiff = vadc - CMIX_CURRENT_VREF;
    
    /* 电流计算：I = (Vadc - Vref) / (Rs * Gain) */
    float current = vdiff / (CMIX_CURRENT_SENSE_RS * CMIX_CURRENT_SENSE_GAIN);
    
    /* 溢出保护 */
    if (current > 100.0f) current = 100.0f;      // 最大100A保护
    if (current < -100.0f) current = -100.0f;    // 最小-100A保护
    
    return current;
}

/**
 * @brief 电流校准函数
 * @param phase: 相别 ('A' or 'B')
 * @param offset_correction: 零点校正值
 * @retval 校准后的电流值
 */
float CMix_Hardware_Calibrate_Current(char phase, float raw_current, float offset_correction)
{
    /* 零点校正 */
    float calibrated = raw_current - offset_correction;
    
    /* 增益校正（如果需要） */
    // calibrated *= gain_correction_factor;
    
    return calibrated;
}
```

### 4. 外部比较器 ❌ 完全缺失

<a id="external-comparator-fix"></a>
**硬件修正建议**：
```c
/* 硬件连接要求：*/
// TP181A1_OUT_A -> 外部比较器A正输入
// TP181A1_OUT_B -> 外部比较器B正输入  
// 比较器负输入 -> 过流阈值电压 (如3.5V对应40A)
// 比较器输出 -> PTM280x BKIN输入 (PA8或PB4)

/* 代码配置：*/
void CMix_Hardware_Init_External_Comparator_BKIN(void)
{
    /* 配置外部比较器输入引脚为BKIN */
    GPIO_InitTypeDef GPIO_InitStruct;
    
    /* 配置BKIN引脚 - 连接外部比较器输出 */
    RCC_APBPeriph2ClockCmd(RCC_APBPeriph2_GPIOA, ENABLE);
    
    GPIO_InitStruct.GPIO_Pin = GPIO_Pin_8;        // PA8作为外部BKIN输入
    GPIO_InitStruct.GPIO_Mode = GPIO_Mode_In;     // 输入模式
    GPIO_InitStruct.GPIO_Pull = GPIO_Pull_Up;     // 上拉，低电平触发保护
    GPIO_Init(GPIOA, &GPIO_InitStruct);
    
    /* TIM1 BKIN配置连接到外部引脚 */
    TIM_BKICRInitTypeDef TIM_BKICRInitStruct;
    TIM_BKICRInitStruct.TIM_Break = TIM_Break_Enable;
    TIM_BKICRInitStruct.TIM_BreakPolarity = TIM_BreakPolarity_Low;  // 低电平触发
    TIM_BKICRInit(TIM1, &TIM_BKICRInitStruct);
}
```

### 5. CMP使用正确性 ✅ 满足
**现状**：片内CMP1用于Vin阈值，CMP0用于Vout阈值，配置正确

### 6. PCB要点 ❓ 无法验证

<a id="pcb-checklist"></a>
**PCB检查清单**：
- [ ] 分流电阻采用4线Kelvin连接
- [ ] TP181A1芯片紧邻分流电阻放置（<5mm）
- [ ] TP181A1电源去耦电容：100nF+10µF靠近芯片
- [ ] 电流采样信号RC滤波：R=100Ω, C=1nF（截止频率1.6MHz）
- [ ] 分流电阻大电流走线宽度足够（>2mm每10A）
- [ ] 敏感的电流采样走线远离开关噪声源

### 7. 日志输出 ⚠️ 部分满足

<a id="logging-fix"></a>
**修正代码**：
```c
/* 在CMix_main.c或日志模块中添加 */
void CMix_Main_Print_Status(void)
{
    /* 读取ADC值 */
    uint16_t adc_vin = CMix_Hardware_Get_ADC_Value(CMIX_ADC_VIN_CHANNEL);
    uint16_t adc_vout = CMix_Hardware_Get_ADC_Value(CMIX_ADC_VOUT_CHANNEL);
    uint16_t adc_ia = CMix_Hardware_Get_ADC_Value(CMIX_ADC_CURRENT_A_CHANNEL);
    uint16_t adc_ib = CMix_Hardware_Get_ADC_Value(CMIX_ADC_CURRENT_B_CHANNEL);
    
    /* 转换为物理量 */
    float vin = adc_vin * 5.0f / 4095.0f * 20.0f;  // 假设20:1分压
    float vout = adc_vout * 5.0f / 4095.0f * 20.0f;
    float current_a = CMix_Hardware_Convert_Current(adc_ia);
    float current_b = CMix_Hardware_Convert_Current(adc_ib);
    
    /* UART输出 */
    printf("Vin=%.2fV, Vout=%.2fV, Ia=%.3fA, Ib=%.3fA\r\n", 
           vin, vout, current_a, current_b);
}
```

---

## 🧮 阈值计算示例

### 过流阈值计算 (I_trip -> ADC counts)

**已知参数**：
- Rs = 0.25mΩ = 0.00025Ω
- Gain = 50 (TP181A1)
- VREF = VDDA/2 = 2.5V
- ADC分辨率 = 12bit = 4095 counts
- VDDA = 5.0V

**计算过程**：

1. **设定过流阈值**：I_trip = 40A

2. **TP181A1输出电压**：
   ```
   V_tp181a1 = VREF + (I_trip × Rs × Gain)
   V_tp181a1 = 2.5V + (40A × 0.00025Ω × 50)
   V_tp181a1 = 2.5V + 0.5V = 3.0V
   ```

3. **对应ADC计数值**：
   ```
   ADC_counts = (V_tp181a1 / VDDA) × 4095
   ADC_counts = (3.0V / 5.0V) × 4095
   ADC_counts = 0.6 × 4095 = 2457 counts
   ```

4. **软件阈值设置**：
   ```c
   #define CMIX_CURRENT_TRIP_40A_COUNTS    2457    // 40A对应的ADC计数
   #define CMIX_CURRENT_TRIP_20A_COUNTS    1638    // 20A对应的ADC计数
   #define CMIX_CURRENT_TRIP_10A_COUNTS    1229    // 10A对应的ADC计数
   ```

### 外部比较器阈值设置

**硬件设置**：
- 比较器正输入：TP181A1输出 (0~5V)
- 比较器负输入：固定阈值电压
- 比较器输出：低电平触发BKIN

**40A阈值的参考电压**：3.0V
**20A阈值的参考电压**：2.75V

---

## 📋 修复优先级建议

### 🚨 高优先级（上板前必须）
1. **完成相A/相B电流ADC通道配置**
2. **实现TP181A1电流换算公式**
3. **规划外部比较器硬件连接**

### ⚠️ 中优先级（测试阶段）
1. **统一ADC采样时间设置**
2. **完善电流日志输出**
3. **验证PCB布局要点**

### ✅ 低优先级（优化阶段）
1. **添加电流校准功能**
2. **优化过流保护响应速度**

---

*检查完成时间：2025年9月17日*
*建议：完成高优先级修复后重新检查*