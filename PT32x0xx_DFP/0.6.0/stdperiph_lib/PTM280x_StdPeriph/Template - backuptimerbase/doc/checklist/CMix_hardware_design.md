
# 📘 CMix 双向两相 DCDC 系统统一自检清单（PTM280x LQFP32）

## 🎯 系统设计要求

### 功能

* **双向 DCDC**：支持 BUCK (降压充电) 与 BOOST (升压放电)
* **模式判定**：

  * Vin > 60V → BUCK 模式
  * Vout < 55V → BOOST 模式
* **模式切换**：带防抖，ADC 二次确认，避免大电流冲击
* **双相设计**：两相交错 180°，共享电流，降低纹波

### 硬件接口

* **ADC**

  * Vin → PB12 (ADC0\_IN0)
  * Vout → PA2 (ADC0\_IN2)
  * 相A电流 → 独立 ADC 通道（OPA1 缓冲）
  * 相B电流 → 独立 ADC 通道（OPA2 缓冲）
  * 高压侧电流 → PA6 (ADC0\_IN6, TP181A1 输出, Vref=VDDA/2)
  * 低压侧电流 → PA0/PA1 其中之一
  * 电池 4 串电压 → PA0 / PA1 / PA6 / PA7（分压输入）
  * NTC 温度监控 → PB7 / PB8 / PB9 / PB13（多点采样）
  * 参考电压：VDDA = 5V
  * 触发方式：TIM1 TRGO
* **OPA**

  * OPA1 缓冲相A电流采样
  * OPA2 缓冲相B电流采样
* **CMP**

  * CMP1: Vin vs LDAC(60V)，输出=PA8
  * CMP0: Vout vs LDAC(55V)，输出=PB4
  * CMP2: MOSFET/电感过温保护 (NTC)
  * CMP3: 电池过压保护
  * CMP 输出必须接 TIM1 BKIN
* **PWM**

  * TIM1\_CH1/CH1N → 相A半桥
  * TIM1\_CH2/CH2N → 相B半桥
  * PWM频率 = 100kHz
  * 相移 = 180°
  * 死区时间 = 200ns（100–500ns 可调）
  * 上电默认关闭
* **UART**

  * UART0: PA15 (TX), PB2 (RX)，115200bps
  * 协议：Modbus-RTU + CRC16
* **均衡**

  * BAL1–BAL4 → GPIO 输出（PB0/PB1/PB3/PB4）驱动均衡 MOS

### 安全

* **TIM1\_BKIN** 必须启用
* **CMP 硬件保护** 立即关断 PWM
* **ADC 软件检测** 提供二次确认
* **IWDG 看门狗** 必须启用
* **软启动**：PWM 占空比渐进式上升
* **过流/短路保护**：高压+低压电流双向检测，支持快速关断

### 调试/维护

* **UART Debug 输出**：初始化、模式切换、故障事件
* **LED 状态指示**：至少 2 个（运行 / 故障）
* **错误码**：区分过压 / 欠压 / 过流 / 短路 / 过温 / 通信

---

## 📊 系统自检清单

### 1. 工程级

| 序号  | 检查项目         | 要求      |
| --- | ------------ | ------- |
| 1.1 | 编译状态         | 无错误、无警告 |
| 1.2 | 中断函数名称       | 与启动文件一致 |
| 1.3 | PT32x API兼容性 | 全部替换完成  |

### 2. 时钟与电源

| 序号  | 检查项目     | 要求         |
| --- | -------- | ---------- |
| 2.1 | 系统时钟     | 48MHz      |
| 2.2 | TIM1输出频率 | 100kHz ±5% |
| 2.3 | ADC参考电压  | VDDA=5.0V  |

### 3. ADC / OPA / CMP

| 序号   | 检查项目     | 要求                  |
| ---- | -------- | ------------------- |
| 3.1  | Vin采样    | PB12 (ADC0\_IN0)    |
| 3.2  | Vout采样   | PA2 (ADC0\_IN2)     |
| 3.3  | 相A电流采样   | OPA1 缓冲 + 独立 ADC 通道 |
| 3.4  | 相B电流采样   | OPA2 缓冲 + 独立 ADC 通道 |
| 3.5  | 高压侧电流采样  | PA6 (TP181A1 输出)    |
| 3.6  | 低压侧电流采样  | PA0/PA1 之一          |
| 3.7  | 电池电压检测   | 4 通道（Cell1–4）       |
| 3.8  | NTC 温度监控 | ≥4 通道               |
| 3.9  | ADC触发源   | TIM1 TRGO           |
| 3.10 | CMP1配置   | Vin >60V 阈值，输出PA8   |
| 3.11 | CMP0配置   | Vout <55V 阈值，输出PB4  |
| 3.12 | CMP2配置   | MOSFET/电感过温保护       |
| 3.13 | CMP3配置   | 电池过压保护              |
| 3.14 | CMP→BKIN | CMP输出接TIM1\_BKIN    |

### 4. PWM (TIM1，两相)

| 序号  | 检查项目   | 要求                |
| --- | ------ | ----------------- |
| 4.1 | 相A输出   | TIM1\_CH1/CH1N 正确 |
| 4.2 | 相B输出   | TIM1\_CH2/CH2N 正确 |
| 4.3 | 相移     | 180° ±5%          |
| 4.4 | 死区时间   | 100–500ns 范围      |
| 4.5 | BKIN保护 | 启用并有效             |
| 4.6 | 初始状态   | PWM默认关闭           |

### 5. 模式切换逻辑

| 序号  | 检查项目    | 要求                     |
| --- | ------- | ---------------------- |
| 5.1 | CMP ISR | CMP0/1/2/3 Handler 已实现 |
| 5.2 | ADC确认   | 防抖逻辑完整                 |
| 5.3 | 切换过程    | 先关PWM，再切换模式，再开PWM      |
| 5.4 | 软启动     | 占空比渐进上升                |

### 6. UART

| 序号  | 检查项目 | 要求                 |
| --- | ---- | ------------------ |
| 6.1 | 引脚   | PA15 TX / PB2 RX   |
| 6.2 | 波特率  | 115200bps          |
| 6.3 | 协议   | Modbus-RTU + CRC16 |
| 6.4 | 错误处理 | 超时、丢包恢复            |

### 7. 安全保护

| 序号  | 检查项目     | 要求              |
| --- | -------- | --------------- |
| 7.1 | BKIN硬件保护 | 立即关断PWM         |
| 7.2 | 过压保护     | Vin>60V 检测      |
| 7.3 | 欠压保护     | Vout<55V 检测     |
| 7.4 | 过流保护     | 相A+相B+高压+低压电流检测 |
| 7.5 | 短路保护     | TP181A1 检测快速关断  |
| 7.6 | 过温保护     | NTC + CMP2      |
| 7.7 | 看门狗      | IWDG 已启用        |

### 8. 调试/维护

| 序号  | 检查项目   | 要求                |
| --- | ------ | ----------------- |
| 8.1 | UART日志 | 初始化/切换/故障输出       |
| 8.2 | LED指示  | 至少运行/故障两个         |
| 8.3 | 错误码    | 过压/欠压/过流/短路/过温/通信 |

### 9. 资源占用

| 序号  | 检查项目  | 要求           |
| --- | ----- | ------------ |
| 9.1 | DMA通道 | ADC+UART 不冲突 |
| 9.2 | Flash | ≤32KB        |
| 9.3 | SRAM  | ≤8KB         |
| 9.4 | CPU占用 | <80% @100kHz |

---
## 🔧 执行流程 
1. **首次自检**：跑完整清单 → 输出状态表格 
2. **修复问题** → 
3. **复查 Prompt**：输出对比表格（上次 vs 本次） 
4. **直到所有必需项✅** 
5. **人工核对 PCB 引脚映射** 
6. **上板烧录**