

# 📘 Copilot 自检工作流文档（CMix 双向 DCDC，PTM280x）

## 1. 系统设计要求

### 功能要求

* **双向 DCDC**：支持 BUCK (降压充电) 与 BOOST (升压放电)。
* **模式判定**：

  * Vin > 60V → BUCK 模式 (充电)
  * Vout < 55V → BOOST 模式 (放电)
* **模式切换**：必须具备防抖，使用 ADC 二次确认，避免大电流冲击。

### 硬件接口

* **ADC**

  * Vin → PB12 (ADC0\_IN0)
  * Vout → PA2 (ADC0\_IN2)
* **OPA**

  * PA3 输入，PA5 输出 → 跟随器缓冲 Vin 分压
* **CMP**

  * CMP1: Vin vs LDAC(60V)，输出=PA8
  * CMP0: Vout vs LDAC(55V)，输出=PB4
  * CMP 输出必须接 TIM1 BKIN
* **PWM (TIM1)**

  * CH1 = PA5 (高边)，CH1N = PA7 (低边)
  * 频率 = 100kHz
  * 死区时间 = 200ns（可调 100–500ns）
  * 上电默认关闭，初始化后不直接导通
* **UART**

  * UART0: PA15 (TX), PB2 (RX)，115200bps

### 安全要求

* **TIM1\_BKIN 硬件保护**必须启用
* **CMP 硬件保护**立即关断 PWM
* **ADC 软件检测**提供二次确认
* **看门狗 (IWDG)** 必须启用
* **软启动逻辑**：PWM 占空比渐进式上升

### 调试与可维护性

* **UART Debug 输出**：初始化、模式切换、故障事件必须有日志
* **LED 状态指示**：至少 2 个（运行 / 故障）
* **错误码**：区分过压 / 欠压 / 过流 / 通信错误

---

## 2. 自检 Checklist

在每次开发迭代后，请 Copilot 对代码逐项检查，并输出表格结果。

### 1. 工程级

* [ ] 中断函数名称是否与启动文件一致？

### 2. 时钟与电源

* [ ] 系统时钟 = 48MHz？
* [ ] TIM1 分频 → PWM = 100kHz？
* [ ] ADC 参考电压 = 5.0V？

### 3. ADC / OPA / CMP

* [ ] Vin=PB12(ADC0\_IN0)，Vout=PA2(ADC0\_IN2)？
* [ ] ADC 触发源 = TIM1 TRGO？
* [ ] OPA0 是否为跟随器 (PA3→PA5)？
* [ ] CMP1 = Vin vs 60V，输出=PA8？
* [ ] CMP0 = Vout vs 55V，输出=PB4？
* [ ] CMP 输出是否接入 TIM1 BKIN？

### 4. PWM (TIM1)

* [ ] TIM1\_CH1=PA5, TIM1\_CH1N=PA7 正确？
* [ ] 死区时间在 100–500ns 范围？
* [ ] TIM1\_BKIN 是否启用并有效？
* [ ] PWM 初始化是否默认关闭？

### 5. 模式切换

* [ ] CMP 中断函数是否已实现？
* [ ] 模式切换是否有 ADC 二次确认和防抖？
* [ ] 模式切换前是否关闭 PWM？

### 6. UART

* [ ] UART0=PA15(TX), PB2(RX)，115200bps 正确？
* [ ] 是否有接收错误/超时处理？
* [ ] 是否实现 CRC16 (Modbus-RTU)？

### 7. 安全与保护

* [ ] BKIN 硬件保护能立即关闭 PWM？
* [ ] 过压/欠压/过流检测已实现？
* [ ] IWDG 看门狗已启用？
* [ ] 是否实现 PWM 软启动逻辑？

### 8. 调试与日志

* [ ] 是否有 UART Debug 输出关键状态？
* [ ] 是否有 LED 状态指示 (运行/故障)？
* [ ] 是否定义了错误码区分不同故障？

---

## 3. Copilot 首次自检 Prompt

```
请你根据以下系统设计要求和自检 Checklist，逐项检查代码是否满足条件。
请输出一个表格，列出【类别 | 条目 | 状态(✅/❌/⚠️) | 备注说明】。
```

---

## 4. Copilot 复查 Prompt

在每次修改后，请运行以下 Prompt，生成对比表格：

```
请你基于上一次自检结果，重新对照系统设计要求和 Checklist 进行检查。
输出一个对比表格，列出【类别 | 条目 | 上次状态 | 本次状态 | 变化说明】。
规则：
- ❌ → ✅ 标注为【已修复】
- ⚠️ → ✅ 标注为【优化完成】
- ❌ → ❌ 标注为【遗留问题】
- ✅ → ❌ 标注为【新增问题 (严重)】
- ✅ → ✅ 保持不变，可略写
```

---

## 5. 工作流总结

1. **开发新代码** →
2. **运行首次自检 Prompt** → 得到全量 Checklist 表格 →
3. **修改代码** →
4. **运行复查 Prompt** → 得到对比结果，确认修复情况 →
5. **循环直到所有条目** ✅ →
6. **人工检查硬件连线** → 上板烧录。
7. **把自检报告输出到st_report.md** → 

