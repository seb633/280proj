# CMix 双向 DCDC 控制器工程师说明文档

## 工程概述

### 工程整体功能
CMix 双向 DCDC 控制器是一个基于 PTM280x 微控制器的智能电源管理系统，具备以下核心功能：

- **双向电能转换**：支持 BUCK (降压充电) 和 BOOST (升压放电) 两种工作模式
- **智能模式切换**：基于电压阈值自动切换工作模式，支持手动控制
- **硬件级安全保护**：过压、欠压、过流三重保护机制
- **实时通信**：UART Modbus-RTU 协议，支持远程监控和参数设置
- **高精度控制**：双闭环 PI 控制算法，电压电流精确调节

### 应用场景
- 储能系统充放电控制
- 电动汽车充电桩
- UPS 不间断电源
- 太阳能逆变器
- 工业电源模块

### 核心模块概览
- **PWM 控制模块**：TIM1 生成 100kHz 互补 PWM 信号
- **ADC 采样模块**：双通道同步采样，电压电流实时监测
- **CMP 保护模块**：硬件级过压保护，微秒级响应
- **UART 通信模块**：Modbus-RTU 协议，CRC16 校验
- **DCDC 控制算法**：双 PI 控制器，自适应模式切换
- **安全保护逻辑**：看门狗、软启动、防抖机制

---

## 文件/模块说明

### 文件: CMix_main.c
#### 文件概述
- **功能**：主程序入口，任务调度器，系统状态管理
- **依赖**：CMix_hardware.h, CMix_protocol.h, CMix_dcdc.h

#### 模块: main()
- **功能**：程序主入口，系统初始化和主循环
- **输入**：无
- **输出**：无返回值
- **关键流程**：
  1. 调用 CMix_Main_System_Init() 初始化系统
  2. 设置应用状态为 RUNNING
  3. 无限循环执行任务调度和看门狗喂狗
- **注意事项**：主循环中包含低功耗模式支持 (__WFI())

#### 模块: CMix_Main_Task_Scheduler()
- **功能**：多级任务调度器，管理不同周期的任务
- **输入**：无
- **输出**：无
- **任务周期**：
  - 1ms：DCDC 控制任务
  - 10ms：通信处理任务
  - 100ms：系统监控任务
  - 1000ms：LED 指示和统计任务
- **注意事项**：基于 SysTick 计时，需要系统滴答中断支持

#### 模块: CMix_Main_Get_System_Tick()
- **功能**：获取系统运行时间戳
- **输入**：无
- **输出**：uint32_t 时间戳 (毫秒)
- **注意事项**：依赖 SysTick 中断更新全局计数器

#### 模块: CMix_Main_System_Reset()
- **功能**：系统安全复位
- **输入**：CMix_Reset_Type_t 复位类型
- **输出**：无
- **安全措施**：复位前先关闭 DCDC 输出，保存复位原因

---

### 文件: CMix_hardware.c
#### 文件概述
- **功能**：硬件抽象层，外设初始化和底层驱动
- **依赖**：PT32x0xx 标准库，CMix_config.h

#### 模块: CMix_Hardware_Init()
- **功能**：系统硬件总初始化
- **输入**：无
- **输出**：无
- **初始化顺序**：
  1. 系统时钟配置 (48MHz)
  2. GPIO 基础配置
  3. UART 通信接口
  4. ADC 采样系统
  5. OPA 电压跟随器
  6. CMP 比较器保护
  7. TIM PWM 生成器
- **注意事项**：初始化顺序不可改变，确保硬件依赖关系

#### 模块: CMix_Hardware_UART_Init()
- **功能**：UART0 通信接口初始化
- **输入**：无
- **输出**：无
- **硬件映射**：
  | 信号 | 引脚 | 配置 | 说明 |
  |------|------|------|------|
  | TX | PA15 | 推挽输出 | 发送数据 |
  | RX | PB2 | 上拉输入 | 接收数据 |
- **通信参数**：
  - 波特率：115200 bps
  - 数据位：8 位
  - 停止位：1 位
  - 校验位：无
- **注意事项**：使能 UART 接收中断，优先级设为 1

#### 模块: CMix_Hardware_ADC_Init()
- **功能**：12 位 ADC 采样系统初始化
- **输入**：无
- **输出**：无
- **硬件映射**：
  | 通道 | 引脚 | 功能 | 采样范围 |
  |------|------|------|----------|
  | ADC0_IN0 | PB12 | Vin 高压侧电压 | 0-60V |
  | ADC0_IN2 | PA2 | Vout 输出电压 | 0-60V |
- **配置参数**：
  - 参考电压：VDDA (5.0V)
  - 采样时间：3 个时钟周期
  - 触发方式：TIM1 TRGO 硬件触发
  - 分辨率：12 位 (0-4095)
- **注意事项**：配置为定时器触发模式，每个 PWM 周期自动采样

#### 模块: CMix_Hardware_OPA_Init()
- **功能**：运算放大器电压跟随器初始化
- **输入**：无
- **输出**：无
- **硬件映射**：
  | 信号 | 引脚 | 配置 | 说明 |
  |------|------|------|------|
  | 输入 | PA3 | 模拟输入 | Vin 分压信号 |
  | 输出 | 内部连接 | - | 直接连接 ADC |
- **配置参数**：
  - 模式：电压跟随器
  - 增益：1.0 (单位增益)
- **注意事项**：输出不使用 PA5 引脚，避免与 PWM 冲突

#### 模块: CMix_Hardware_CMP_Init()
- **功能**：比较器硬件保护系统初始化
- **输入**：无
- **输出**：无
- **硬件映射**：
  | 比较器 | 输入+ | 输入- | 输出 | 阈值 | 功能 |
  |--------|-------|-------|------|------|------|
  | CMP1 | Vin | LDAC(3.0V) | PA8 | 60V | Vin 过压保护 |
  | CMP0 | Vout | LDAC(2.75V) | PB4 | 55V | Vout 过压保护 |
- **保护机制**：
  - 输出直接连接 TIM1_BKIN
  - 低电平触发立即关断 PWM
  - 中断服务程序记录故障状态
- **注意事项**：CMP 输出优先级高于软件控制

#### 模块: CMix_Hardware_TIM_Init()
- **功能**：TIM1 PWM 信号生成器初始化
- **输入**：无
- **输出**：无
- **硬件映射**：
  | 信号 | 引脚 | 配置 | 功能 |
  |------|------|------|------|
  | TIM1_CH1 | PA5 | 推挽输出 | 高边开关控制 |
  | TIM1_CH1N | PA7 | 推挽输出 | 低边开关控制 |
  | TIM1_BKIN | PA8 | 上拉输入 | 硬件保护输入 |
- **时序参数**：
  - PWM 频率：100kHz (ARR=479)
  - 死区时间：~200ns (10 个时钟周期)
  - 占空比范围：5%-95%
  - 初始状态：输出关闭
- **触发配置**：
  - TRGO 输出：每个更新事件触发 ADC
  - BKIN 保护：低电平立即关断
- **注意事项**：死区时间防止上下管直通，BKIN 具有最高优先级

#### 模块: CMix_Hardware_Set_PWM_Duty()
- **功能**：设置 PWM 占空比
- **输入**：
  - uint8_t channel: PWM 通道 (1-4)
  - uint16_t duty_cycle: 占空比 (0-10000，对应 0-100.00%)
- **输出**：无
- **计算公式**：pulse = (duty_cycle × CMIX_PWM_PERIOD) / 10000
- **通道映射**：
  - 通道 1：TIM1_CH1 (BUCK 上管)
  - 通道 2：TIM1_CH1N (BUCK 下管，自动互补)
- **注意事项**：互补输出自动处理死区时间

#### 模块: CMix_Hardware_ADC_Read()
- **功能**：读取指定通道 ADC 值
- **输入**：uint8_t channel (ADC 通道号)
- **输出**：uint16_t ADC 原始值 (0-4095)
- **通道映射**：
  - 通道 0：PB12 (Vin)
  - 通道 2：PA2 (Vout)
- **转换时序**：
  1. 选择通道
  2. 启动转换
  3. 等待完成标志
  4. 读取结果
- **注意事项**：使用较长采样时间确保精度

---

### 文件: CMix_dcdc.c
#### 文件概述
- **功能**：DCDC 控制算法核心，PI 调节器，模式切换逻辑
- **依赖**：CMix_hardware.h, CMix_protocol.h, math.h

#### 模块: CMix_DCDC_Init()
- **功能**：DCDC 控制系统初始化
- **输入**：无
- **输出**：无
- **初始化内容**：
  - 电压 PI 控制器：Kp=1.0, Ki=0.1
  - 电流 PI 控制器：Kp=0.5, Ki=0.05
  - 系统状态设置为 INIT
  - PWM 占空比设为 0
- **安全设置**：
  - 电压设定值：24V
  - 电流限制：10A
  - 控制输出范围：0-10000
- **注意事项**：所有 PWM 输出初始化为 0，确保安全启动

#### 模块: CMix_DCDC_Control_Task()
- **功能**：主控制任务，1ms 周期执行
- **输入**：无
- **输出**：无
- **控制流程**：
  1. 更新测量值 (电压、电流)
  2. 执行安全检查
  3. 模式选择判断
  4. PI 控制器计算
  5. PWM 输出更新
  6. 效率计算
- **注意事项**：控制周期固定 1ms，保证系统稳定性

#### 模块: CMix_DCDC_Update_Measurements()
- **功能**：更新所有测量值
- **输入**：无
- **输出**：更新全局状态结构
- **测量内容**：
  - Vin：输入电压 (mV)
  - Vout：输出电压 (mV)
  - Iin：输入电流 (mA)
  - Iout：输出电流 (mA)
- **转换公式**：
  - 电压：voltage_mv = (adc_value × 5000 × voltage_divider) / 4095
  - 电流：current_ma = (adc_value × 5000 × current_ratio) / 4095
- **注意事项**：使用硬件触发确保采样同步

#### 模块: CMix_DCDC_Mode_Selection()
- **功能**：工作模式自动选择
- **输入**：当前电压测量值
- **输出**：更新工作模式
- **模式判断**：
  - Vin > 60V → BUCK 模式 (降压充电)
  - Vout < 55V → BOOST 模式 (升压放电)
  - 其他情况 → IDLE 模式
- **防抖机制**：连续 N 次相同判断才切换模式
- **注意事项**：模式切换前自动关闭 PWM 输出

#### 模块: CMix_DCDC_PI_Controller_Update()
- **功能**：PI 控制器算法实现
- **输入**：
  - CMix_PI_Controller_t *pi: PI 控制器结构指针
  - float setpoint: 设定值
  - float feedback: 反馈值
- **输出**：float 控制输出
- **控制算法**：
  - error = setpoint - feedback
  - integral += error × dt
  - output = Kp × error + Ki × integral
- **限幅处理**：输出限制在 [min, max] 范围内
- **注意事项**：积分项有防饱和处理

#### 模块: CMix_DCDC_Safety_Check()
- **功能**：安全保护检查
- **输入**：当前系统状态
- **输出**：故障标志更新
- **检查项目**：
  - 过压保护：Vin > 65V 或 Vout > 65V
  - 欠压保护：Vin < 10V
  - 过流保护：Iin > 15A 或 Iout > 15A
  - 温度保护：Temp > 85°C
- **保护动作**：
  - 立即关闭 PWM 输出
  - 设置故障标志
  - 记录故障类型
- **注意事项**：安全检查优先级最高

---

### 文件: CMix_protocol.c
#### 文件概述
- **功能**：UART 通信协议实现，Modbus-RTU 格式
- **依赖**：CMix_hardware.h, string.h

#### 模块: CMix_Protocol_Init()
- **功能**：通信协议初始化
- **输入**：无
- **输出**：无
- **初始化内容**：
  - 系统参数默认值设置
  - 接收缓冲区清零
  - 状态机初始化
- **默认参数**：
  - 输入电压阈值：60V
  - 输出电压阈值：60V
  - 最大电流：150A
  - 最大功率：450W
- **注意事项**：所有参数以 mV/mA/mW 为单位存储

#### 模块: CMix_Protocol_Handle_Received_Data()
- **功能**：接收数据解析处理
- **输入**：
  - const uint8_t *data: 接收数据缓冲区
  - uint8_t length: 数据长度
- **输出**：解析结果
- **协议格式**：[设备地址][功能码][数据][CRC16]
- **支持命令**：
  - 0x03：读取寄存器
  - 0x06：写入单个寄存器
  - 0x10：写入多个寄存器
- **注意事项**：所有数据包必须通过 CRC16 校验

#### 模块: CMix_Protocol_CRC16()
- **功能**：Modbus-RTU CRC16 校验计算
- **输入**：
  - const uint8_t *data: 数据缓冲区
  - uint8_t length: 数据长度
- **输出**：uint16_t CRC16 校验值
- **算法**：标准 Modbus-RTU CRC16 查表算法
- **初始值**：0xFFFF
- **多项式**：0xA001
- **注意事项**：低字节在前，高字节在后

#### 模块: CMix_Protocol_Send_Response()
- **功能**：发送响应数据包
- **输入**：
  - const uint8_t *data: 响应数据
  - uint8_t length: 数据长度
- **输出**：发送状态
- **数据格式**：[响应数据][CRC16]
- **发送流程**：
  1. 添加 CRC16 校验
  2. 逐字节发送
  3. 等待发送完成
- **注意事项**：发送前检查 UART 发送缓冲区状态

#### 模块: CMix_Protocol_Handle_Query_Status()
- **功能**：处理状态查询命令
- **输入**：无
- **输出**：发送当前系统状态
- **状态内容**：
  - 工作模式和状态
  - 输入/输出电压电流
  - 系统效率
  - 故障标志
- **数据格式**：16 字节状态数据
- **注意事项**：实时获取最新测量值

---

### 文件: CMix_config.h
#### 文件概述
- **功能**：系统配置参数定义，硬件引脚映射
- **依赖**：PT32x0xx.h, stdint.h, stdbool.h

#### 主要配置参数

##### 系统时钟配置
```c
#define CMIX_SYSTEM_CLOCK_HZ        48000000    // 48MHz 系统时钟
#define CMIX_APB_CLOCK_HZ           48000000    // APB 时钟频率
```

##### PWM 配置参数
```c
#define CMIX_PWM_FREQUENCY_HZ       100000      // 100kHz PWM频率
#define CMIX_PWM_PERIOD             480         // PWM周期计数
#define CMIX_PWM_DEADTIME           10          // 死区时间 (~200ns)
```

##### 硬件引脚映射
| 功能 | 引脚 | 说明 |
|------|------|------|
| UART_TX | PA15 | 串口发送 |
| UART_RX | PB2 | 串口接收 |
| PWM_CH1 | PA5 | 高边开关 |
| PWM_CH1N | PA7 | 低边开关 |
| ADC_VIN | PB12 | 输入电压采样 |
| ADC_VOUT | PA2 | 输出电压采样 |
| CMP1_OUT | PA8 | 过压保护输出 |
| CMP0_OUT | PB4 | 过压保护输出 |

---

## 硬件配置要求

### 系统时钟设置
- **主时钟**：48MHz HSI 内部振荡器
- **APB 时钟**：48MHz (不分频)
- **时钟源稳定性**：±1% 以内
- **时钟配置验证**：启动时输出调试信息确认

### PWM/TIM 配置
- **定时器**：TIM1 高级定时器
- **PWM 频率**：100kHz ±1%
- **死区时间**：200ns ±50ns (防止上下管直通)
- **占空比范围**：5%-95% (避免极限占空比)
- **初始状态**：上电默认关闭，软件使能后才输出
- **硬件保护**：BKIN 输入连接 CMP 输出，低电平触发

### ADC/OPA/CMP 配置
- **ADC 单元**：ADC0，12 位分辨率
- **参考电压**：VDDA = 5.0V ±1%
- **采样频率**：100kHz (TIM1 TRGO 触发)
- **输入阻抗**：>1MΩ (高阻抗输入)
- **OPA 配置**：电压跟随器，单位增益
- **CMP 阈值**：LDAC 配置，3.0V/2.75V 对应 60V/55V
- **保护延时**：<1μs 硬件响应时间

### UART 波特率及接口映射
- **UART 单元**：UART0
- **波特率**：115200 bps
- **数据格式**：8N1 (8 数据位，无校验，1 停止位)
- **流控制**：无
- **协议**：Modbus-RTU with CRC16
- **中断优先级**：1 (较高优先级)

### 外设依赖或初始化顺序
1. **RCC 时钟使能** (所有外设时钟)
2. **GPIO 基础配置** (所有引脚模式设置)
3. **UART 通信接口** (调试输出依赖)
4. **ADC 采样系统** (测量反馈依赖)
5. **OPA 信号调理** (ADC 输入调理)
6. **CMP 保护系统** (硬件安全依赖)
7. **TIM PWM 生成** (控制输出，最后初始化)
8. **全局中断使能** (系统就绪)

---

## 异常与保护逻辑

### 过流保护
- **检测方式**：ADC 采样 + 软件判断
- **阈值设置**：
  - 输入电流：15A (可配置)
  - 输出电流：15A (可配置)
- **响应时间**：1ms (软件检测周期)
- **保护动作**：
  1. 立即关闭 PWM 输出
  2. 设置过流故障标志
  3. 记录故障时间戳
  4. 发送 UART 故障通知
- **恢复条件**：手动清除故障标志 + 电流正常

### 过压保护
- **硬件保护**：CMP 比较器 + TIM1_BKIN
  - 响应时间：<1μs
  - 阈值：Vin > 60V, Vout > 55V
  - 动作：立即关断 PWM
- **软件保护**：ADC 采样 + 软件判断
  - 响应时间：1ms
  - 阈值：可软件配置
  - 动作：软件关断 + 故障记录
- **双重保护**：硬件保护 + 软件确认

### 欠压保护
- **检测方式**：ADC 采样 + 软件判断
- **阈值设置**：
  - 输入欠压：10V
  - 输出欠压：5V
- **响应时间**：1ms
- **保护动作**：
  1. 停止 DCDC 工作
  2. 设置欠压故障标志
  3. 进入待机模式
- **恢复条件**：电压恢复正常 + 延时确认

### 看门狗
- **看门狗类型**：IWDG 独立看门狗
- **超时时间**：100ms
- **喂狗周期**：50ms (主循环)
- **复位条件**：程序死机或主循环停止
- **复位后处理**：
  1. 读取复位原因
  2. 记录看门狗复位事件
  3. 执行安全初始化

### 模式切换防抖/软启动
- **防抖机制**：
  - 电压判断需连续 N 次一致
  - 防抖时间：10ms
  - ADC 二次确认
- **软启动逻辑**：
  - 启动时占空比从 5% 开始
  - 每 1ms 增加 1%
  - 渐进式达到目标占空比
  - 启动时间：<100ms
- **模式切换流程**：
  1. 检测到切换条件
  2. 关闭当前 PWM 输出
  3. 等待防抖时间
  4. ADC 二次确认
  5. 切换到新模式
  6. 执行软启动

---

## 调试与注意事项

### Debug UART 指示
- **调试接口**：UART0 (PA15/PB2, 115200bps)
- **输出内容**：
  - 系统启动信息
  - 模式切换事件
  - 故障告警信息
  - 实时测量数据
  - 性能统计信息
- **调试命令**：
  ```
  [INIT] CMix DCDC Controller v1.0.0
  [INFO] System Clock: 48MHz OK
  [INFO] ADC Calibration: OK
  [WARN] Mode Switch: IDLE -> BUCK
  [ERROR] Over Current: Iin=16.5A
  [STATUS] Vin=50.2V Vout=24.1V Eff=92.3%
  ```

### LED 状态指示
- **运行 LED** (PA4)：
  - 正常运行：1Hz 闪烁
  - 系统故障：常亮
  - 初始化：快速闪烁 (10Hz)
- **故障 LED** (PA5)：
  - 无故障：熄灭
  - 过压故障：常亮
  - 过流故障：2Hz 闪烁
  - 通信故障：5Hz 闪烁

### 故障状态码/日志说明
| 故障码 | 故障类型 | 描述 | 恢复方式 |
|--------|----------|------|----------|
| 0x01 | 输入过压 | Vin > 65V | 降低输入电压 |
| 0x02 | 输出过压 | Vout > 65V | 检查负载 |
| 0x04 | 输入过流 | Iin > 15A | 减少负载功率 |
| 0x08 | 输出过流 | Iout > 15A | 检查短路 |
| 0x10 | 过温保护 | Temp > 85°C | 改善散热 |
| 0x20 | 通信错误 | UART 超时 | 检查连线 |
| 0x40 | ADC 故障 | 采样异常 | 重启系统 |
| 0x80 | 看门狗复位 | 程序异常 | 检查代码 |

### 调试技巧
1. **硬件调试**：
   - 使用示波器检查 PWM 波形和死区时间
   - 万用表验证电压电流测量精度
   - 逻辑分析仪监控 UART 通信

2. **软件调试**：
   - 开启 UART 调试输出查看实时状态
   - 监控 ADC 采样值验证模拟量精度
   - 检查任务调度器统计信息

3. **性能优化**：
   - 调整 PI 控制器参数改善动态响应
   - 优化 PWM 频率平衡效率和纹波
   - 监控 CPU 使用率确保实时性

### 常见问题及建议
1. **PWM 输出异常**：
   - 检查 TIM1_BKIN 是否被 CMP 触发
   - 验证死区时间设置是否合理
   - 确认 GPIO 复用功能配置正确

2. **ADC 采样不准确**：
   - 检查 VDDA 电源是否稳定在 5.0V
   - 验证采样时间是否足够长
   - 确认 TIM1 TRGO 触发配置正确

3. **通信异常**：
   - 检查波特率设置是否一致
   - 验证 CRC16 校验算法实现
   - 确认接收中断是否正常响应

4. **系统不稳定**：
   - 检查看门狗喂狗是否及时
   - 验证任务调度器时序是否正确
   - 确认中断优先级设置合理

5. **保护功能失效**：
   - 检查 CMP 阈值设置是否正确
   - 验证 BKIN 硬件连接是否可靠
   - 确认软件保护逻辑是否生效

### 推荐测试流程
1. **静态测试**：上电检查，无负载运行
2. **动态测试**：轻载到满载渐进测试
3. **保护测试**：故意触发各种保护功能
4. **长时间测试**：连续运行 24 小时稳定性测试
5. **极限测试**：边界条件和异常情况测试

---

**文档版本**：v1.0.0  
**最后更新**：2025年9月17日  
**维护者**：CMix开发团队